name: CI-CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  backend:
    name: Backend (FastAPI + MongoDB)
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      MONGODB_URI: mongodb://localhost:27017/sasskyc
      MONGODB_DB_NAME: sasskyc

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backend tests
        working-directory: backend
        run: pytest

  frontend:
    name: Frontend (Vue 3 + Vite)
    runs-on: ubuntu-latest
    needs: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci || npm install

      - name: Run frontend tests
        working-directory: frontend
        run: npm run test

      - name: Build frontend
        working-directory: frontend
        run: npm run build

  deploy:
    name: Deploy to Lightsail
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: CI-CD

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: SSH & deploy to Lightsail
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT || 22 }}
          script: |
            set -e

            APP_DIR="/home/bitnami/sass-kyc"

            echo "üìÅ Going to project directory"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            if [ ! -d ".git" ]; then
              echo "üîÅ Cloning repository"
              git clone https://github.com/TU_USER/TU_REPO.git .
            else
              echo "üîÅ Updating repository"
              git fetch --all
              git reset --hard origin/main || git reset --hard origin/master
            fi

            echo "üêç Updating backend"
            cd "$APP_DIR/backend"

            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
            fi

            source .venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            echo "üìù Creating backend .env"
            cat <<EOF > $APP_DIR/backend/.env
            MONGODB_URI=${{ secrets.BACKEND_MONGODB_URI }}
            MONGODB_DB_NAME=${{ secrets.BACKEND_MONGODB_DB_NAME }}
            EOF

            echo "üåê Updating frontend"
            cd "$APP_DIR/frontend"

            echo "üìù Creating frontend .env"
            cat <<EOF > $APP_DIR/frontend/.env
            VITE_API_BASE_URL=${{ secrets.FRONTEND_API_URL }}
            EOF

            npm install
            npm run build

            TARGET_DIR="/opt/bitnami/apache/htdocs/sass-kyc"
            sudo mkdir -p "$TARGET_DIR"
            sudo rm -rf "$TARGET_DIR"/*
            sudo cp -r dist/* "$TARGET_DIR"/

            echo "‚ôªÔ∏è Restarting services"
            # sudo systemctl restart sasskyc-backend
            # or PM2 here...

            echo "‚úÖ Deploy completed!"
